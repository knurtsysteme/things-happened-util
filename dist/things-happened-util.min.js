/*! things-happened-util v0.3.1 | (c) 2013-2014 KNURT Systeme | MIT License */
"use strict";var ThingsDate={};ThingsDate.getDate=function(a,b){b=b||"_date";var c=a[b],d=c.length>3?c.substr(0,4)-0:0,e=c.length>5?c.substr(4,2)-1:0,f=c.length>7?c.substr(6,2)-0:0,g=c.length>9?c.substr(8,2)-0:0,h=c.length>11?c.substr(10,2)-0:0,i=c.length>13?c.substr(12,2)-0:0;return new Date(d,e,f,g,h,i)};var ThingsForest=function(a){var b={},c=function(a,b){for(var c=[],d=a.length;d--;)"undefined"!=typeof a[d][b]&&c.push(a[d][b]);return c},d=function(b){return b=b||a,c(b,"_rid")};return b.containsTree=function(a){return d().indexOf(a._rid)>=0},b.without=function(b){"undefined"!=typeof b._rid&&(b=[b]);for(var c=[],e=d(b),f=a.length;f--;)e.indexOf(a[f]._rid)<0&&c.push(a[f]);return c},b.getLatest=function(b){b=b||"_date";for(var c=!1,d=a.length;d--;)if(a[d][b]){for(var e=a[d][b];1e13>e;)e*=10;(!c||e>c[b])&&(c=a[d])}return c},b},ThingsQuery={};ThingsQuery._produce=function(a,b){var b=b||{};b.action=b.action||"get",b.criteria=b.criteria||{};var c=this;if(a=a||"things","string"!=typeof a||!a.match(/^[a-z]+$/))throw new Error('must have "things" (@see mongo\'s collection name)');this.thatHaveNoChildIn=function(a){return this.whose("_id").isNotIn(a,"_pid")},this.thatAreRoot=function(){return this.whose("_pid").is(null)},this.thatHaveAChildIn=function(a){return this.whose("_id").isIn(a,"_pid")},this.inSameForestAs=function(a){return this.whose("_rid").isIn(a,"_rid")},this.inSameTreeAs=function(a){return this.whose("_rid").is(a._rid)},this.branchOf=function(a){for(var b=a._branch||"0",c=["0"];b.length>1;)c.push(b),b=b.substr(0,b.lastIndexOf(","));return this.inSameTreeAs(a).whose("_branch").isIn(c)},this.that=function(a){if("string"!=typeof a||!a.match(/^[a-z\-]+$/))throw new Error('must have "things" (@see mongo\'s collection name)');return b.happened=a,c},this.hasCriterion=function(a){return"undefined"!=typeof b.criteria[a]},this.setSecret=function(a){return b.criteria._secret=a,c},this.inSameTreeAs=function(a){var d=a;return a&&"object"==typeof a&&a._rid&&(d=a._rid),b.criteria._rid=d,c},this.whoseDateIsBetween=function(a,b,c,d){return c=c||"_date",d=d||"_date",this.whose(c).isGreaterOrEqualThan(a).whose(d).isLowerThan(b)},this.whose=function(a){var d={},e=function(c,d,e){if(d){var f=[];b.criteria[a]&&b.criteria[a][e]&&(f=b.criteria[a][e]);for(var g=0;g<c.length;g++){var h=c[g][d];h&&f.indexOf(h)<0&&f.push(h)}c=f}var i={};return i[e]=c,i};return d.isIn=function(d,f){return b.criteria[a]=e(d,f,"$in"),c},d.isGreaterThan=function(d,f){return b.criteria[a]=e(d,f,"$gt"),c},d.isLowerThan=function(d,f){return b.criteria[a]=e(d,f,"$lt"),c},d.isGreaterOrEqualThan=function(d,f){return b.criteria[a]=e(d,f,"$gte"),c},d.isLowerOrEqualThan=function(d,f){return b.criteria[a]=e(d,f,"$lte"),c},d.exists=function(){return b.criteria[a]={$exists:!0},c},d.isNotIn=function(d,f){return b.criteria[a]=e(d,f,"$nin"),c},d.is=function(d){return b.criteria[a]=d,c},d},this.count=function(){return b.action="count",c},this.url=function(){var c=b.happened?"/"+b.happened:"",d=JSON.stringify(b.criteria);return d="{}"==d?"":"?criteria="+d,"/"+b.action+"/"+a+c+".json"+d}},ThingsQuery.select=function(a){return new ThingsQuery._produce(a,{action:"get"})},ThingsQuery.count=function(a){return new ThingsQuery._produce(a,{action:"count"})},ThingsQuery.getCopyForUpdate=function(a){for(var b={},c=Object.keys(a),d=c.length;--d;)c[d].match(/^_/)&&(b[c[d]]=a[c[d]]);return b},ThingsQuery.validForInsertion=function(a){var b={};return b.things=function(){var b=["things","everything"];return!!a.match(/^[a-z]+$/)&&b.indexOf(a)<0},b.happened=function(){return!!a.match(/^[a-z]+$/)},b.json=function(b){b="undefined"==typeof b?!1:!!b;var c=!0;try{b&&(a=JSON.parse(a));var d=JSON.stringify(a);c=!!d.match(/^\{.+\}$/);var e=[];if(c&&(e=Object.keys(a),c=e.length<=20),c)for(var f=e.length;f--;)if("object"==typeof a[e[f]]&&JSON.stringify(a[e[f]]).match(/^\{/)){c=!1;break}}catch(g){c=!1}return c},b},ThingsQuery.add=function(a){var b={};return b.to=function(b,c){var d={};return d.isValid=function(){return ThingsQuery.validForInsertion(c).happened()&&ThingsQuery.validForInsertion(b).things()&&ThingsQuery.validForInsertion(a).json()},d.url=function(){return d.isValid()?"/addto/"+b+"/"+c+".json":!1},d.getThing=function(){return"string"==typeof a&&(a=JSON.parse(a)),d.isValid()?a:!1},d},b};